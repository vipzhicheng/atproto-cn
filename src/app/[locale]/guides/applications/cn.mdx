import Link from 'next/link'
import {FooterCTA} from "@/components/FooterCTA"
import AppBanner from './app-banner.png'
import AppLogin from './app-login.png'
import AppScreenshot from './app-screenshot.png'
import AppStatusHistory from './app-status-history.png'
import AppStatusOptions from './app-status-options.png'
import DiagramEventStream from './diagram-event-stream.png'
import DiagramInfoFlow from './diagram-info-flow.png'
import DiagramOauth from './diagram-oauth.png'
import DiagramOptimisticUpdate from './diagram-optimistic-update.png'
import DiagramRepo from './diagram-repo.png'

export const metadata = {
  title: 'æ„å»º AT åè®®åº”ç”¨ç¨‹åºçš„å¿«é€Ÿå…¥é—¨æŒ‡å—',
  description:
    'åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•çš„å¤šç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œç”¨äºå‘å¸ƒæ‚¨å½“å‰çš„â€œçŠ¶æ€â€ä½œä¸ºè¡¨æƒ…ç¬¦å·ã€‚',
}

# æ„å»º AT åè®®åº”ç”¨ç¨‹åºçš„å¿«é€Ÿå…¥é—¨æŒ‡å—

<Link href="https://github.com/bluesky-social/statusphere-example-app" className="not-prose flex items-center gap-2 bg-blue-100 dark:bg-blue-950 dark:text-white px-4 py-3 text-base rounded-lg hover:underline">
  <svg viewBox="0 0 20 20" aria-hidden="true" className="h-6 dark:text-white">
    <path
      fill="currentColor"
      fillRule="evenodd"
      clipRule="evenodd"
      d="M10 1.667c-4.605 0-8.334 3.823-8.334 8.544 0 3.78 2.385 6.974 5.698 8.106.417.075.573-.182.573-.406 0-.203-.011-.875-.011-1.592-2.093.397-2.635-.522-2.802-1.002-.094-.246-.5-1.005-.854-1.207-.291-.16-.708-.556-.01-.567.656-.01 1.124.62 1.281.876.75 1.292 1.948.93 2.427.705.073-.555.291-.93.531-1.143-1.854-.213-3.791-.95-3.791-4.218 0-.929.322-1.698.854-2.296-.083-.214-.375-1.09.083-2.265 0 0 .698-.224 2.292.876a7.576 7.576 0 0 1 2.083-.288c.709 0 1.417.096 2.084.288 1.593-1.11 2.291-.875 2.291-.875.459 1.174.167 2.05.084 2.263.53.599.854 1.357.854 2.297 0 3.278-1.948 4.005-3.802 4.219.302.266.563.78.563 1.58 0 1.143-.011 2.061-.011 2.35 0 .224.156.491.573.405a8.365 8.365 0 0 0 4.11-3.116 8.707 8.707 0 0 0 1.567-4.99c0-4.721-3.73-8.545-8.334-8.545Z"
    />
  </svg>
  <span>
    Find the source code for the example application on GitHub.
  </span>
</Link>

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•çš„å¤šç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œç”¨äºå‘å¸ƒæ‚¨å½“å‰çš„â€œçŠ¶æ€â€ä½œä¸ºè¡¨æƒ…ç¬¦å·ã€‚æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†å¦‚ä¸‹æ‰€ç¤ºï¼š{{className: 'lead'}}

<Image alt="æˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºçš„å±å¹•æˆªå›¾" src={AppScreenshot} />

æˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ï¼š{{className: 'lead'}}

- é€šè¿‡ OAuth ç™»å½• {{className: 'lead'}}
- è·å–æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆä¸ªäººèµ„æ–™ï¼‰ {{className: 'lead'}}
- ç›‘å¬ç½‘ç»œä¿¡æ¯æµä»¥è·å–æ–°æ•°æ® {{className: 'lead'}}
- ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å¼åœ¨ç”¨æˆ·çš„å¸æˆ·ä¸Šå‘å¸ƒæ•°æ® {{className: 'lead'}}

æˆ‘ä»¬å°†ä¿æŒç®€æ´ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥å¿«é€Ÿäº†è§£ ATProtoã€‚å°†æä¾›æŒ‡å‘æ¯ä¸ªæ­¥éª¤çš„æ›´å¤šä¿¡æ¯çš„é“¾æ¥ã€‚{{className: 'lead'}}

## ä»‹ç»

Atmosphere ä¸­çš„æ•°æ®å­˜å‚¨åœ¨ç”¨æˆ·çš„ä¸ªäºº repo ä¸­ã€‚è¿™å‡ ä¹å°±åƒæ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„ç½‘ç«™ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ç”¨æˆ·çš„æ•°æ®èšåˆåˆ°æˆ‘ä»¬çš„ SQLite æ•°æ®åº“ä¸­ã€‚

å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæƒ³è±¡æˆä¸€ä¸ª Googleã€‚å¦‚æœ Google çš„å·¥ä½œæ˜¯è¯´æ¯ä¸ªç½‘ç«™åœ¨ `/status.json` ä¸‹æœ‰å“ªäº›è¡¨æƒ…ç¬¦å·ï¼Œé‚£ä¹ˆå®ƒä¼šæ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ï¼š

- `nytimes.com` æ ¹æ® `https://nytimes.com/status.json` çš„è¯´æ³•ï¼Œæ„Ÿè§‰æ˜¯ ğŸ“°
- `bsky.app` æ ¹æ® `https://bsky.app/status.json` çš„è¯´æ³•ï¼Œæ„Ÿè§‰æ˜¯ ğŸ¦‹
- `reddit.com` æ ¹æ® `https://reddit.com/status.json` çš„è¯´æ³•ï¼Œæ„Ÿè§‰æ˜¯ ğŸ¤“

Atmosphere çš„å·¥ä½œæ–¹å¼ç›¸åŒï¼Œåªæ˜¯æˆ‘ä»¬å°†æ£€æŸ¥ `at://` è€Œä¸æ˜¯ `https://`ã€‚æ¯ä¸ªç”¨æˆ·åœ¨ `at://` URL ä¸‹éƒ½æœ‰ä¸€ä¸ªæ•°æ® repoã€‚æˆ‘ä»¬å°†çˆ¬å– Atmosphere ä¸­æ‰€æœ‰ç”¨æˆ·æ•°æ® repo ä¸­çš„æ‰€æœ‰ "status.json" è®°å½•ï¼Œå¹¶å°†å®ƒä»¬èšåˆåˆ°æˆ‘ä»¬çš„ SQLite æ•°æ®åº“ä¸­ã€‚

> `at://` æ˜¯ AT åè®®çš„ URL æ–¹æ¡ˆã€‚åœ¨åº•å±‚ï¼Œå®ƒä½¿ç”¨ HTTP å’Œ DNS ç­‰å¸¸è§æŠ€æœ¯ï¼Œä½†å®ƒæ·»åŠ äº†æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚

## ç¬¬ 1 æ­¥ã€‚ä»æˆ‘ä»¬çš„ ExpressJS åº”ç”¨ç¨‹åºå¼€å§‹

é¦–å…ˆå…‹éš† repo å¹¶å®‰è£…è½¯ä»¶åŒ…ã€‚


```bash
git clone https://github.com/bluesky-social/statusphere-example-app.git
cd statusphere-example-app
cp .env.template .env
npm install
npm run dev
# Navigate to http://localhost:8080
```

æˆ‘ä»¬çš„ repo æ˜¯ä¸€ä¸ªå¸¸è§„çš„ Web åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬åƒ 1999 å¹´é‚£æ ·åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æˆ‘ä»¬çš„ HTMLã€‚æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª SQLite æ•°æ®åº“ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ [Kysely](https://kysely.dev/) è¿›è¡Œç®¡ç†ã€‚

æˆ‘ä»¬çš„èµ·å§‹å †æ ˆï¼š

- Typescript
- NodeJS Web æœåŠ¡å™¨ ([express](https://expressjs.com/))
- SQLite æ•°æ®åº“ ([Kysely](https://kysely.dev/))
- æœåŠ¡å™¨ç«¯æ¸²æŸ“ ([uhtml](https://www.npmjs.com/package/uhtml))

åœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å°†è§£é‡Šæˆ‘ä»¬çš„ Web åº”ç”¨ç¨‹åºå¦‚ä½•æ¥å…¥ Atmosphereã€‚æœ‰å…³æ›´è¯¦ç»†çš„ä»£ç ï¼Œè¯·å‚é˜…ä»£ç åº“ &mdash; åŒæ ·ï¼Œæœ¬æ•™ç¨‹å°†ä¿æŒç®€æ´æ˜äº†ã€‚

## ç¬¬ 2 æ­¥ã€‚ä½¿ç”¨ OAuth ç™»å½•

å½“æœ‰äººç™»å½•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œä»–ä»¬å°†æˆäºˆæˆ‘ä»¬å¯¹å…¶ä¸ªäºº `at://` repo çš„è¯»å–å’Œå†™å…¥æƒé™ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å†™å…¥çŠ¶æ€ json è®°å½•ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ OAuth ([spec](https://github.com/bluesky-social/proposals/tree/main/0004-oauth)) æ¥å®Œæˆæ­¤æ“ä½œã€‚å¤§å¤šæ•° OAuth æµç¨‹å°†ä½¿ç”¨ [@atproto/oauth-client-node](https://github.com/bluesky-social/atproto/tree/main/packages/oauth/oauth-client-node) åº“ä¸ºæˆ‘ä»¬å¤„ç†ã€‚è¿™æ˜¯æˆ‘ä»¬è¿½æ±‚çš„å®‰æ’ï¼š

<Image alt="OAuth å…ƒç´ çš„ç¤ºæ„å›¾" src={DiagramOauth} />

å½“ç”¨æˆ·ç™»å½•æ—¶ï¼ŒOAuth å®¢æˆ·ç«¯å°†ä¸ä»–ä»¬çš„ repo æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ï¼Œå¹¶ä¸ºæˆ‘ä»¬æä¾›è¯»/å†™è®¿é—®æƒé™ä»¥åŠåŸºæœ¬ç”¨æˆ·ä¿¡æ¯ã€‚

<Image alt="ç™»å½•ç”¨æˆ·ç•Œé¢çš„å±å¹•æˆªå›¾" src={AppLogin} />

æˆ‘ä»¬çš„ç™»å½•é¡µé¢åªæ˜¯è¦æ±‚ç”¨æˆ·æä¾›ä»–ä»¬çš„â€œhandleâ€ï¼Œè¿™æ˜¯ä¸å…¶å¸æˆ·å…³è”çš„åŸŸåã€‚å¯¹äº [Bluesky](https://bsky.app) ç”¨æˆ·ï¼Œè¿™äº›åŸŸåé€šå¸¸çœ‹èµ·æ¥åƒ `alice.bsky.social`ï¼Œä½†å®ƒä»¬å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„åŸŸåï¼ˆä¾‹å¦‚ `alice.com`ï¼‰ã€‚

```html
<!-- src/pages/login.ts -->
<form action="/login" method="post" class="login-form">
  <input
    type="text"
    name="handle"
    placeholder="Enter your handle (eg alice.bsky.social)"
    required
  />
  <button type="submit">Log in</button>
</form>
```

å½“ä»–ä»¬æäº¤è¡¨å•æ—¶ï¼Œæˆ‘ä»¬ä¼šå‘Šè¯‰ OAuth å®¢æˆ·ç«¯å¯åŠ¨æˆæƒæµç¨‹ï¼Œç„¶åå°†ç”¨æˆ·é‡å®šå‘åˆ°ä»–ä»¬çš„æœåŠ¡å™¨ä»¥å®Œæˆè¯¥è¿‡ç¨‹ã€‚


```typescript
/** src/routes.ts **/
// Login handler
router.post(
  '/login',
  handler(async (req, res) => {
    // Initiate the OAuth flow
    const handle = req.body?.handle
    const url = await oauthClient.authorize(handle, {
      scope: 'atproto transition:generic',
    })
    return res.redirect(url.toString())
  })
)
```

è¿™æ˜¯ä¸ Google æˆ– GitHub ä½¿ç”¨çš„ç›¸åŒç±»å‹çš„ SSO æµç¨‹ã€‚ç³»ç»Ÿä¼šè¦æ±‚ç”¨æˆ·è¾“å…¥å¯†ç ï¼Œç„¶åè¦æ±‚ç¡®è®¤ä¸æ‚¨çš„åº”ç”¨ç¨‹åºçš„ä¼šè¯ã€‚

å®Œæˆåï¼Œç”¨æˆ·å°†è¢«å‘é€å›æˆ‘ä»¬çš„ Web åº”ç”¨ç¨‹åºä¸Šçš„ `/oauth/callback`ã€‚OAuth å®¢æˆ·ç«¯å°†å­˜å‚¨ç”¨æˆ·æœåŠ¡å™¨çš„è®¿é—®ä»¤ç‰Œï¼Œç„¶åæˆ‘ä»¬å°†ä»–ä»¬å¸æˆ·çš„ [DID](https://atproto.com/specs/did) é™„åŠ åˆ° cookie ä¼šè¯ã€‚

```typescript
/** src/routes.ts **/
// OAuth callback to complete session creation
router.get(
  '/oauth/callback',
  handler(async (req, res) => {
    // Store the credentials
    const { session } = await oauthClient.callback(params)

    // Attach the account DID to our user via a cookie
    const cookieSession = await getIronSession(req, res)
    cookieSession.did = session.did
    await cookieSession.save()

    // Send them back to the app
    return res.redirect('/')
  })
)
```

æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å·¥ä½œäº†ï¼æˆ‘ä»¬ç°åœ¨ä¸ç”¨æˆ·çš„ repo æœåŠ¡å™¨å»ºç«‹äº†ä¸€ä¸ªä¼šè¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—®ä»–ä»¬çš„æ•°æ®ã€‚

## ç¬¬ 3 æ­¥ã€‚è·å–ç”¨æˆ·çš„ä¸ªäººèµ„æ–™

æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸äº†è§£ä¸€ä¸‹æˆ‘ä»¬çš„ç”¨æˆ·å‘¢ï¼Ÿåœ¨ [Bluesky](https://bsky.app) ä¸­ï¼Œç”¨æˆ·å‘å¸ƒä¸€ä¸ªâ€œprofileâ€è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š


```typescript
interface ProfileRecord {
  displayName?: string // a human friendly name
  description?: string // a short bio
  avatar?: BlobRef     // small profile picture
  banner?: BlobRef     // banner image to put on profiles
  createdAt?: string   // declared time this profile data was added
  // ...
}
```

æ‚¨å¯ä»¥ä½¿ç”¨ [atproto-browser.vercel.app](https://atproto-browser.vercel.app) ç›´æ¥æ£€æŸ¥æ­¤è®°å½•ã€‚ä¾‹å¦‚ï¼Œ[è¿™æ˜¯ @bsky.app çš„ profile è®°å½•](https://atproto-browser.vercel.app/at?u=at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.actor.profile/self)ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ä¸ç”¨æˆ·çš„ OAuth ä¼šè¯å…³è”çš„ [Agent](https://github.com/bluesky-social/atproto/tree/main/packages/api) æ¥è·å–æ­¤è®°å½•ã€‚


```typescript
await agent.com.atproto.repo.getRecord({
  repo: agent.assertDid,                // The user
  collection: 'app.bsky.actor.profile', // The collection
  rkey: 'self',                         // The record key
})
```

åœ¨è¯·æ±‚è®°å½•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸‰ä¸ªä¿¡æ¯ã€‚

- **repo** ç”¨äºæ ‡è¯†ç”¨æˆ·çš„ [DID](https://atproto.com/specs/did)ï¼Œ
- **collection** é›†åˆåç§°ï¼Œä»¥åŠ
- **rkey** è®°å½•é”®

æˆ‘ä»¬ç¨åä¼šè§£é‡Šé›†åˆåç§°ã€‚è®°å½•é”®æ˜¯å…·æœ‰[ä¸€äº›é™åˆ¶](https://atproto.com/specs/record-key#record-key-syntax)çš„å­—ç¬¦ä¸²å’Œä¸€äº›å¸¸è§çš„æ¨¡å¼ã€‚å½“é›†åˆé¢„è®¡ä»…åŒ…å«ä¸€ä¸ªæè¿°ç”¨æˆ·çš„è®°å½•æ—¶ï¼Œä½¿ç”¨ `"self"` æ¨¡å¼ã€‚

è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„ä¸»é¡µä»¥è·å–æ­¤ä¸ªäººèµ„æ–™è®°å½•ï¼š

```typescript
/** src/routes.ts **/
// Homepage
router.get(
  '/',
  handler(async (req, res) => {
    // If the user is signed in, get an agent which communicates with their server
    const agent = await getSessionAgent(req, res, ctx)

    if (!agent) {
      // Serve the logged-out view
      return res.type('html').send(page(home()))
    }

    // Fetch additional information about the logged-in user
    const { data: profileRecord } = await agent.com.atproto.repo.getRecord({
      repo: agent.assertDid,                // our user's repo
      collection: 'app.bsky.actor.profile', // the bluesky profile record type
      rkey: 'self',                         // the record's key
    })

    // Serve the logged-in view
    return res
      .type('html')
      .send(page(home({ profile: profileRecord.value || {} })))
  })
)
```

With that data, we can give a nice personalized welcome banner for our user:

<Image alt="A screenshot of the banner image" src={AppBanner} />

```html
<!-- pages/home.ts -->
<div class="card">
  ${profile
    ? html`<form action="/logout" method="post" class="session-form">
        <div>
          Hi, <strong>${profile.displayName || 'friend'}</strong>.
          What's your status today?
        </div>
        <div>
          <button type="submit">Log out</button>
        </div>
      </form>`
    : html`<div class="session-form">
        <div><a href="/login">Log in</a> to set your status!</div>
        <div>
          <a href="/login" class="button">Log in</a>
        </div>
      </div>`}
</div>
```

## ç¬¬ 4 æ­¥ã€‚è¯»å–å’Œå†™å…¥è®°å½•

æ‚¨å¯ä»¥å°†ç”¨æˆ·å­˜å‚¨åº“è§†ä¸º JSON è®°å½•çš„é›†åˆï¼š

<Image alt="å­˜å‚¨åº“çš„ç¤ºæ„å›¾" src={DiagramRepo} />

è®©æˆ‘ä»¬å†æ¬¡çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•è¯»å–â€œprofileâ€è®°å½•ï¼š

```typescript
await agent.com.atproto.repo.getRecord({
  repo: agent.assertDid,                // The user
  collection: 'app.bsky.actor.profile', // The collection
  rkey: 'self',                         // The record key
})
```

æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼çš„ API å†™å…¥è®°å½•ã€‚ç”±äºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å†™å…¥â€œçŠ¶æ€â€è®°å½•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼š


```typescript
// Generate a time-based key for our record
const rkey = TID.nextStr()

// Write the
await agent.com.atproto.repo.putRecord({
  repo: agent.assertDid,                 // The user
  collection: 'xyz.statusphere.status',  // The collection
  rkey,                                  // The record key
  record: {                              // The record value
    status: "ğŸ‘",
    createdAt: new Date().toISOString()
  }
})
```

æˆ‘ä»¬çš„ `POST /status` è·¯ç”±å°†ä½¿ç”¨æ­¤ API å°†ç”¨æˆ·çš„çŠ¶æ€å‘å¸ƒåˆ°ä»–ä»¬çš„ repoã€‚

```typescript
/** src/routes.ts **/
// "Set status" handler
router.post(
  '/status',
  handler(async (req, res) => {
    // If the user is signed in, get an agent which communicates with their server
    const agent = await getSessionAgent(req, res, ctx)
    if (!agent) {
      return res.status(401).type('html').send('<h1>Error: Session required</h1>')
    }

    // Construct their status record
    const record = {
      $type: 'xyz.statusphere.status',
      status: req.body?.status,
      createdAt: new Date().toISOString(),
    }

    try {
      // Write the status record to the user's repository
      await agent.com.atproto.putRecord({
        repo: agent.assertDid,
        collection: 'xyz.statusphere.status',
        rkey: TID.nextStr(),
        record,
      })
    } catch (err) {
      logger.warn({ err }, 'failed to write record')
      return res.status(500).type('html').send('<h1>Error: Failed to write record</h1>')
    }

    res.status(200).json({})
  })
)
```

ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬çš„ä¸»é¡µä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—å‡ºçŠ¶æ€æŒ‰é’®ï¼š

```html
<!-- src/pages/home.ts -->
<form action="/status" method="post" class="status-options">
  ${STATUS_OPTIONS.map(status => html`
    <button class="status-option" name="status" value="${status}">
      ${status}
    </button>
  `)}
</form>
```

And here we are!

<Image alt="A screenshot of the app's status options" src={AppStatusOptions} />

## ç¬¬ 5 æ­¥ã€‚åˆ›å»ºè‡ªå®šä¹‰â€œçŠ¶æ€â€æ¨¡å¼

Repo é›†åˆæ˜¯ç±»å‹åŒ–çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å…·æœ‰å®šä¹‰çš„æ¨¡å¼ã€‚`app.bsky.actor.profile` ç±»å‹å®šä¹‰[å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°](https://github.com/bluesky-social/atproto/blob/main/lexicons/app/bsky/actor/profile.json)ã€‚

ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ [Lexicon](https://atproto.com/specs/lexicon) è¯­è¨€åˆ›å»ºä¸€ä¸ªæ–°æ¨¡å¼ï¼Œè¯¥è¯­è¨€ä¸ [JSON-Schema](http://json-schema.org/) éå¸¸ç›¸ä¼¼ã€‚è¿™äº›æ¨¡å¼ä½¿ç”¨ [åå‘ DNS ID](https://atproto.com/specs/nsid)ï¼Œç”¨äºæŒ‡ç¤ºæ‰€æœ‰æƒã€‚åœ¨æ­¤æ¼”ç¤ºåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸“é—¨ä¸ºæ­¤é¡¹ç›®æ³¨å†Œçš„ `xyz.statusphere`ï¼ˆåˆå statusphere.xyzï¼‰ã€‚

> ### ä¸ºä»€ä¹ˆè¦åˆ›å»ºæ¨¡å¼ï¼Ÿ
>
> æ¨¡å¼å¯ä»¥å¸®åŠ©å…¶ä»–åº”ç”¨ç¨‹åºç†è§£æ‚¨çš„åº”ç”¨ç¨‹åºæ­£åœ¨åˆ›å»ºçš„æ•°æ®ã€‚é€šè¿‡å‘å¸ƒæ‚¨çš„æ¨¡å¼ï¼Œæ‚¨å¯ä»¥ä½¿å…¶ä»–åº”ç”¨ç¨‹åºä½œè€…æ›´å®¹æ˜“ä»¥æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥è¯†åˆ«å’Œå¤„ç†çš„æ ¼å¼å‘å¸ƒæ•°æ®ã€‚

è®©æˆ‘ä»¬åœ¨ä»£ç åº“çš„ `/lexicons` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºæˆ‘ä»¬çš„æ¨¡å¼ã€‚æ‚¨å¯ä»¥[åœ¨æ­¤å¤„é˜…è¯»æœ‰å…³å¦‚ä½•å®šä¹‰æ¨¡å¼çš„æ›´å¤šä¿¡æ¯](https://atproto.com/guides/lexicon)ã€‚


```json
/** lexicons/status.json **/
{
  "lexicon": 1,
  "id": "xyz.statusphere.status",
  "defs": {
    "main": {
      "type": "record",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["status", "createdAt"],
        "properties": {
          "status": {
            "type": "string",
            "minLength": 1,
            "maxGraphemes": 1,
            "maxLength": 32
          },
          "createdAt": {
            "type": "string",
            "format": "datetime"
          }
        }
      }
    }
  }
}
```

ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„æ¨¡å¼è¿è¡Œä¸€äº›ä»£ç ç”Ÿæˆï¼š

```bash
./node_modules/.bin/lex gen-server ./src/lexicon ./lexicons/*
```

è¿™å°†ç”Ÿæˆ Typescript æ¥å£ä»¥åŠè¿è¡Œæ—¶éªŒè¯å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ä»£ç çš„æ ·å­ï¼š


```typescript
/** src/lexicon/types/xyz/statusphere/status.ts **/
export interface Record {
  status: string
  createdAt: string
  [k: string]: unknown
}

export function isRecord(v: unknown): v is Record {
  return (
    isObj(v) &&
    hasProp(v, '$type') &&
    (v.$type === 'xyz.statusphere.status#main' || v.$type === 'xyz.statusphere.status')
  )
}

export function validateRecord(v: unknown): ValidationResult {
  return lexicons.validate('xyz.statusphere.status#main', v)
}
```

è®©æˆ‘ä»¬ä½¿ç”¨è¯¥ä»£ç æ¥æ”¹è¿› `POST /status` è·¯ç”±ï¼š

```typescript
/** src/routes.ts **/
import * as Status from '#/lexicon/types/xyz/statusphere/status'
// ...
// "Set status" handler
router.post(
  '/status',
  handler(async (req, res) => {
    // ...

    // Construct & validate their status record
    const record = {
      $type: 'xyz.statusphere.status',
      status: req.body?.status,
      createdAt: new Date().toISOString(),
    }
    if (!Status.validateRecord(record).success) {
      return res.status(400).json({ error: 'Invalid status' })
    }

    // ...
  })
)
```

## ç¬¬ 6 æ­¥ã€‚ç›‘å¬ä¿¡æ¯æµ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ï¼š

- é€šè¿‡ OAuth ç™»å½•
- åˆ›å»ºäº†è‡ªå®šä¹‰æ¨¡å¼
- è¯»å–å’Œå†™å…¥äº†å·²ç™»å½•ç”¨æˆ·çš„è®°å½•

ç°åœ¨æˆ‘ä»¬è¦ä»å…¶ä»–ç”¨æˆ·é‚£é‡Œè·å–çŠ¶æ€è®°å½•ã€‚

è¿˜è®°å¾—æˆ‘ä»¬å¦‚ä½•å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç§°ä¸ºåƒ Google ä¸€æ ·ï¼Œåœ¨ repo å‘¨å›´çˆ¬è¡Œä»¥è·å–ä»–ä»¬çš„è®°å½•å—ï¼Ÿæˆ‘ä»¬åœ¨ AT åè®®ä¸­çš„ä¸€ä¸ªä¼˜åŠ¿æ˜¯æ¯ä¸ª repo éƒ½å‘å¸ƒäº†å…¶æ›´æ–°çš„äº‹ä»¶æ—¥å¿—ã€‚

<Image alt="äº‹ä»¶æµçš„ç¤ºæ„å›¾" src={DiagramEventStream} />

ä½¿ç”¨ [Relay æœåŠ¡](https://docs.bsky.app/docs/advanced-guides/federation-architecture#relay)ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬ç½‘ç»œä¸­æ‰€æœ‰ç”¨æˆ·çš„è¿™äº›äº‹ä»¶çš„èšåˆä¿¡æ¯æµã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨å¯»æ‰¾æœ‰æ•ˆçš„ `xyz.statusphere.status` è®°å½•ã€‚

```typescript
/** src/ingester.ts **/
import { Firehose } from '@atproto/sync'
import * as Status from '#/lexicon/types/xyz/statusphere/status'
// ...

new Firehose({
  filterCollections: ['xyz.statusphere.status'],
  handleEvent: async (evt) => {
    // Watch for write events
    if (evt.event === 'create' || evt.event === 'update') {
      const record = evt.record

      // If the write is a valid status update
      if (
        evt.collection === 'xyz.statusphere.status' &&
        Status.isRecord(record) &&
        Status.validateRecord(record).success
      ) {
        // Store the status
        // TODO
      }
    }
  },
})
```

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª SQLite è¡¨æ¥å­˜å‚¨è¿™äº›çŠ¶æ€ï¼š

```typescript
/** src/db.ts **/
// Create our statuses table
await db.schema
  .createTable('status')
  .addColumn('uri', 'varchar', (col) => col.primaryKey())
  .addColumn('authorDid', 'varchar', (col) => col.notNull())
  .addColumn('status', 'varchar', (col) => col.notNull())
  .addColumn('createdAt', 'varchar', (col) => col.notNull())
  .addColumn('indexedAt', 'varchar', (col) => col.notNull())
  .execute()
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™äº›çŠ¶æ€ä»ä¿¡æ¯æµä¸­è·å–æ—¶å†™å…¥åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ï¼š

```typescript
/** src/ingester.ts **/
// If the write is a valid status update
if (
  evt.collection === 'xyz.statusphere.status' &&
  Status.isRecord(record) &&
  Status.validateRecord(record).success
) {
  // Store the status in our SQLite
  await db
    .insertInto('status')
    .values({
      uri: evt.uri.toString(),
      authorDid: evt.author,
      status: record.status,
      createdAt: record.createdAt,
      indexedAt: new Date().toISOString(),
    })
    .onConflict((oc) =>
      oc.column('uri').doUpdateSet({
        status: record.status,
        indexedAt: new Date().toISOString(),
      })
    )
    .execute()
}
```

æ‚¨å¯ä»¥å°†ä¿¡æ¯æµè§†ä¸ºä¸€ä¸ªå¾ªç¯ï¼š

<Image alt="ä¿¡æ¯æµçš„ç¤ºæ„å›¾" src={DiagramInfoFlow} />

åº”ç”¨ç¨‹åºå†™å…¥ repoã€‚ç„¶åï¼Œå†™å…¥äº‹ä»¶åœ¨ firehose ä¸Šå‘å‡ºï¼Œåº”ç”¨ç¨‹åºæ•è·è¿™äº›äº‹ä»¶å¹¶å°†å…¶æå–åˆ°å…¶æ•°æ®åº“ä¸­ã€‚

ä¸ºä»€ä¹ˆè¦åƒè¿™æ ·ä»äº‹ä»¶æ—¥å¿—åŒæ­¥ï¼Ÿå› ä¸ºç½‘ç»œä¸­è¿˜æœ‰å…¶ä»–åº”ç”¨ç¨‹åºä¼šå†™å…¥æˆ‘ä»¬æ„Ÿå…´è¶£çš„è®°å½•ã€‚é€šè¿‡è®¢é˜…äº‹ä»¶æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ•è·æ‰€æœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ•°æ® &mdash; åŒ…æ‹¬å…¶ä»–åº”ç”¨ç¨‹åºå‘å¸ƒçš„æ•°æ®ï¼

## ç¬¬ 7 æ­¥ã€‚åˆ—å‡ºæœ€æ–°çŠ¶æ€

ç°åœ¨æˆ‘ä»¬å·²ç»ä½¿ç”¨çŠ¶æ€å¡«å……äº†æˆ‘ä»¬çš„ SQLiteï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆç”¨æˆ·çŠ¶æ€æ›´æ–°çš„æ—¶é—´çº¿ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨ [DID](https://atproto.com/specs/did) åˆ°å¥æŸ„è§£æå™¨ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºå¸¦æœ‰çŠ¶æ€çš„ç”¨æˆ·åï¼š

```typescript
/** src/routes.ts **/
// Homepage
router.get(
  '/',
  handler(async (req, res) => {
    // ...

    // Fetch data stored in our SQLite
    const statuses = await db
      .selectFrom('status')
      .selectAll()
      .orderBy('indexedAt', 'desc')
      .limit(10)
      .execute()

    // Map user DIDs to their domain-name handles
    const didHandleMap = await resolver.resolveDidsToHandles(
      statuses.map((s) => s.authorDid)
    )

    // ...
  })
)
```

æˆ‘ä»¬çš„ HTML ç°åœ¨å¯ä»¥åˆ—å‡ºè¿™äº›çŠ¶æ€è®°å½•ï¼š

```html
<!-- src/pages/home.ts -->
${statuses.map((status, i) => {
  const handle = didHandleMap[status.authorDid] || status.authorDid
  return html`
    <div class="status-line">
      <div>
        <div class="status">${status.status}</div>
      </div>
      <div class="desc">
        <a class="author" href="https://bsky.app/profile/${handle}">@${handle}</a>
        was feeling ${status.status} on ${status.indexedAt}.
      </div>
    </div>
  `
})}
```

<Image alt="A screenshot of the app status timeline" src={AppStatusHistory} />

## ç¬¬ 8 æ­¥ã€‚ä¹è§‚æ›´æ–°

ä½œä¸ºæœ€åçš„ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å¼•å…¥â€œä¹è§‚æ›´æ–°â€ã€‚

è¿˜è®°å¾— repo å†™å…¥å’Œäº‹ä»¶æ—¥å¿—çš„ä¿¡æ¯æµå¾ªç¯å—ï¼Ÿ

<Image alt="ä¿¡æ¯æµçš„ç¤ºæ„å›¾" src={DiagramInfoFlow} />

ç”±äºæˆ‘ä»¬æ­£åœ¨æœ¬åœ°æ›´æ–°ç”¨æˆ·çš„ repoï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥æµç¨‹çŸ­è·¯åˆ°æˆ‘ä»¬è‡ªå·±çš„æ•°æ®åº“ï¼š

<Image alt="å›¾ç¤ºä¹è§‚æ›´æ–°çš„ç¤ºæ„å›¾" src={DiagramOptimisticUpdate} />

è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒç¡®ä¿ç”¨æˆ·åœ¨ä½¿ç”¨æ‚¨çš„åº”ç”¨ç¨‹åºæ—¶çœ‹åˆ°ä»–ä»¬è‡ªå·±çš„æ›´æ”¹ã€‚å½“äº‹ä»¶æœ€ç»ˆä» firehose åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬åªéœ€å°†å…¶ä¸¢å¼ƒï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†å…¶ä¿å­˜åœ¨æœ¬åœ°ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬åªéœ€æ›´æ–° `POST /status` ä»¥åŒ…å«å¯¹æˆ‘ä»¬çš„ SQLite æ•°æ®åº“çš„é¢å¤–å†™å…¥ï¼š


```typescript
/** src/routes.ts **/
// "Set status" handler
router.post(
  '/status',
  handler(async (req, res) => {
    // ...

    let uri
    try {
      // Write the status record to the user's repository
      const res = await agent.com.atproto.repo.putRecord({
        repo: agent.assertDid,
        collection: 'xyz.statusphere.status',
        rkey: TID.nextStr(),
        record,
      })
      uri = res.uri
    } catch (err) {
      logger.warn({ err }, 'failed to write record')
      return res.status(500).json({ error: 'Failed to write record' })
    }

    try {
      // Optimistically update our SQLite <-- HERE!
      await db
        .insertInto('status')
        .values({
          uri,
          authorDid: agent.assertDid,
          status: record.status,
          createdAt: record.createdAt,
          indexedAt: new Date().toISOString(),
        })
        .execute()
    } catch (err) {
      logger.warn(
        { err },
        'failed to update computed view; ignoring as it should be caught by the firehose'
      )
    }

    res.status(200).json({})
  })
)
```

æ‚¨ä¼šæ³¨æ„åˆ°ï¼Œæ­¤ä»£ç ä¸æˆ‘ä»¬åœ¨ `ingester.ts` ä¸­æ‰€åšçš„å‡ ä¹å®Œå…¨ç›¸åŒã€‚

## AT åè®®çš„è®¾è®¡æ€è·¯

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æ„å»º atproto åº”ç”¨çš„å…³é”®æ­¥éª¤ã€‚æ•°æ®ä»¥è§„èŒƒå½¢å¼å‘å¸ƒåœ¨ç”¨æˆ·çš„ `at://` å­˜å‚¨åº“ä¸­ï¼Œç„¶åèšåˆåˆ°åº”ç”¨çš„æ•°æ®åº“ä¸­ï¼Œä»¥ç”Ÿæˆç½‘ç»œçš„è§†å›¾ã€‚

åœ¨æ„å»ºåº”ç”¨æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å››ä¸ªå…³é”®æ­¥éª¤ï¼š

- ä¸ºæ‚¨å°†å‘å¸ƒåˆ° Atmosphere ä¸­çš„è®°å½•è®¾è®¡ [Lexicon](#) æ¨¡å¼ã€‚
- åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œç”¨äºå°†è®°å½•èšåˆä¸ºæœ‰ç”¨çš„è§†å›¾ã€‚
- æ„å»ºæ‚¨çš„åº”ç”¨ç¨‹åºä»¥åœ¨ç”¨æˆ·çš„å­˜å‚¨åº“ä¸Šå†™å…¥è®°å½•ã€‚
- ç›‘å¬ firehose ä»¥èšåˆæ•´ä¸ªç½‘ç»œçš„æ•°æ®ã€‚

è¯·è®°ä½æ•´ä¸ªè¿‡ç¨‹ä¸­çš„ä¿¡æ¯æµï¼š

<Image alt="ä¿¡æ¯æµçš„ç¤ºæ„å›¾" src={DiagramInfoFlow} />

è¿™æ˜¯ Atmosphere ä¸­æ¯ä¸ªåº”ç”¨ç¨‹åºçš„å·¥ä½œæ–¹å¼ï¼ŒåŒ…æ‹¬ [Bluesky ç¤¾äº¤åº”ç”¨](https://bsky.app)ã€‚

## åç»­æ­¥éª¤

å¦‚æœæ‚¨æƒ³ç»ƒä¹ æ‰€å­¦çš„çŸ¥è¯†ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹å…¶ä»–æŒ‘æˆ˜ï¼š

- åŒæ­¥æ‰€æœ‰ç”¨æˆ·çš„ä¸ªäººèµ„æ–™è®°å½•ï¼Œä»¥ä¾¿æ˜¾ç¤ºä»–ä»¬çš„æ˜¾ç¤ºåç§°è€Œä¸æ˜¯å¥æŸ„ã€‚
- ç»Ÿè®¡ä½¿ç”¨çš„æ¯ç§çŠ¶æ€çš„æ•°é‡ï¼Œå¹¶æ˜¾ç¤ºæ€»è®¡æ•°ã€‚
- è·å–å·²éªŒè¯ç”¨æˆ·çš„ `app.bsky.graph.follow` å…³æ³¨è€…ï¼Œå¹¶æ˜¾ç¤ºä»–ä»¬çš„çŠ¶æ€ã€‚
- åˆ›å»ºä¸€ç§ä¸åŒçš„æ¨¡å¼ï¼Œä¾‹å¦‚å‘å¸ƒç½‘ç«™é“¾æ¥å¹¶å°†å…¶è¯„ä¸º 1 åˆ° 4 æ˜Ÿçš„æ–¹å¼ã€‚

<FooterCTA href="/" title="Ready to learn more?" description="Specs, guides, and SDKs can be found here." />