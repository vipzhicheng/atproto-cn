export const metadata = {
  title: '事件流',
  description:
    '用于订阅 Lexicon 对象流的网络线协议',
  wip: true
}

# 事件流（Event Stream）

除了常规的 [HTTP API](/specs/xrpc) 端点外，atproto 还支持持续的事件流。消息模式和端点名称是与传输无关的,在 [Lexicons](/specs/lexicon) 中定义。初始编码和传输方案使用二进制 [DAG-CBOR](https://ipld.io/docs/codecs/known/dag-cbor/) 编码通过 [WebSockets](https://en.wikipedia.org/wiki/WebSocket) 传输。{{ className: 'lead' }}

Lexicon 中流的类型是 `subscription`。模式包含端点标识符(`id`)、`message` 模式(通常是允许多种消息类型的联合类型)以及错误类型列表(`errors`)。

客户端通过在指定端点发起连接来订阅特定的流。当前流是单向的,消息从服务器流向客户端。客户端可以在打开连接时提供查询参数来配置流。

**回填窗口(backfill window)** 机制允许客户端追赶可能错过的流消息。从高层次来看,这通过为流事件分配单调递增的序列号,并允许客户端在发起连接时指定初始序列号来实现。该机制的目的是在合理的时间窗口内(如几小时或几天)确保事件的可靠传递。它的目的不是让客户端回滚到流的最开始。

`com.atproto` 命名空间中的所有初始订阅 Lexicon 都使用回填机制。但是,流并不 _需要_ 回填机制(甚至游标,我们下面会定义)。不需要可靠传递的订阅端点不需要实现回填机制或使用序列号。

初始订阅端点也是公开的,不需要认证或预先许可即可订阅(尽管可能对客户端施加资源限制)。但订阅端点可能在连接时要求使用现有的 HTTP API (XRPC) 认证方法进行认证。

## 流线协议 (v0)

总的来说,消息以 DAG-CBOR 编码通过二进制 WebSocket 发送。客户端连接到特定的 HTTP 端点,带有查询参数,然后升级到 WebSocket。每个 WebSocket 帧包含两个 DAG-CBOR 对象,字节连接在一起:一个头部(指示消息类型)和实际消息。

WebSocket "living standard" 目前由 [WHATWG](https://en.wikipedia.org/wiki/WHATWG) 维护,完整规范可在 [https://websockets.spec.whatwg.org/](https://websockets.spec.whatwg.org/) 找到。

### 连接

客户端通过打开 HTTP 连接并升级到 WebSocket 来初始化流订阅。在互联网上应该使用 HTTPS 和"WebSocket Secure"(`wss://`)并使用默认端口(443)。HTTP、明文 WebSocket(`ws://`)和非标准端口只应用于测试、开发和本地连接(例如,在实现 SSL 的反向代理后面)。从客户端的角度来看,连接升级到 WebSocket 失败视为错误。

可以在初始 HTTP 请求中提供查询参数来以应用程序特定的方式配置流,如端点的 Lexicon 模式中指定。

错误通常通过流本身返回。连接时错误作为流的第一条消息发送,然后服务器断开连接。但有些错误无法通过流处理,而是作为 HTTP 错误返回:

- `405 Method Not Allowed`:对流端点的非 GET HTTP 请求时返回给客户端
- `426 Upgrade Required`:如果请求流端点时未包含 `Upgrade` 头,返回给客户端
- `429 Too Many Requests`:频繁用于速率限制。客户端可在延迟后重试。建议支持 `Retry-After` 头
- `500 Internal Server Error`:客户端可在延迟后重试
- `501 Not Implemented`:服务不实现 WebSocket 或流(至少对此端点)。客户端不应重试
- `502 Bad Gateway`, `503 Service Unavailable`, `504 Gateway Timeout`:客户端可在延迟后重试

服务器对这些状态码 *应该* 返回标准 XRPC 错误消息模式的 JSON 响应体。但客户端也需要对意外的响应体格式保持稳健。常见情况是在计划或非计划停机期间收到负载均衡器或反向代理的默认错误页面。

如果一段时间内没有消息,服务器或客户端都可以决定断开打开的流连接。无限期保持连接打开也是可接受的。

### 帧格式

每个二进制 WebSocket 帧包含两个连接在一起的 DAG-CBOR 对象。第一个是**头部**,第二个是**载荷**。

头部 DAG-CBOR 对象具有以下字段:

- `op` ("operation", 整数, 必需):固定值,表示此帧包含的内容
  - `1`: 常规消息,类型由 `t` 指示
  - `-1`: 错误消息
- `t` ("type", 字符串, 可选):当 `op` 为 `1` 时必需,以简短形式指示此消息的 Lexicon 子类型。不包括完整的 Lexicon 标识符,只有片段。例如: `#commit`。如果 `op` 为 `-1` 则不应包含在头部中。

客户端应忽略具有未知 `op` 或 `t` 值的帧。头部和载荷中的未知字段都应被忽略。无效的帧格式或无效的 DAG-CBOR 编码是严重错误,客户端应断开整个连接而不是跳过该帧。服务器应忽略从客户端接收的任何帧,不将其视为错误。

错误载荷都具有以下字段:

- `error` (字符串, 必需):错误类型名称,不带命名空间或 `#` 前缀
- `message` (字符串, 可选):错误描述

在传输或接收错误帧后应立即关闭流。

消息载荷必须始终是对象。它们应省略 `$type` 字段,因为此信息已在头部中指示。atproto 中没有对 WebSocket 帧大小的特定限制,但应保持合理小(大约几兆字节左右)。

如果客户端无法跟上消息速率,服务器可能发送"太慢"错误并关闭连接。

### 序列号 (Sequence Numbers)

流可以选择性地使用每条消息的序列号来提高传输的可靠性。客户端会跟踪它们最后接收并成功处理的序列号,并可以在重新连接后指定该号码以接收任何错过的消息,直到某个回滚窗口为止。服务器不会在连接之间保存任何客户端状态。这种语义类似于 [Apache Kafka](https://en.wikipedia.org/wiki/Apache_Kafka) 的消费者组和其他流处理协议。

订阅 Lexicon 必须包含 `seq` 字段(整数类型)和 `cursor` 查询参数(整数类型)。并非所有消息类型都需要包含 `seq`。错误消息不包含序列号,而且通常会有一个不需要持久化的 `#info` 消息类型。

序列号始终是正整数(非零),并且单调递增,但在其他方面具有灵活的语义。它们可能包含任意间隔。例如,它们可能是时间戳。

为了避免在使用 JavaScript 时产生混淆(JavaScript 默认将所有数字表示为浮点数),序列号应限制在可以安全地由 64 位浮点数表示的整数范围内。即整数范围 `1` 到 `2^53`(上限不包含)。

连接时关于游标和序列号的规则:

- 未指定 `cursor`:服务器从当前流位置开始传输
- `cursor` 高于当前 `seq`("在未来"):服务器发送错误消息并关闭连接
- `cursor` 在回滚窗口内:服务器发送任何持久化的消息(序列号大于等于指定值),然后在"追赶上"当前流后继续
- `cursor` 早于回滚窗口:流的第一条消息是一个 info 消息,指示 `cursor` 太旧,然后从最早可用的 `seq` 开始,发送整个回滚窗口,然后继续当前流
- `cursor` 为 `0`:服务器将从最早可用的 `seq` 开始,发送整个回滚窗口,然后继续当前流

序列号的范围是服务提供商(主机名)和端点(NSID)的组合。这大致对应于用于连接的 `wss://` URL。也就是说,序列号在同一服务的不同流端点之间可能是唯一的,也可能不是唯一的。

服务应确保序列号不被重复使用,通常是通过在通过流传输事件之前将事件(带序列号)提交到可靠的持久存储中。

在某些灾难性故障模式下(或基础设施发生重大变更),服务器可能会丢失回填窗口中的数据,并需要将序列号重置回 `1`。在这种情况下,如果客户端使用更高的序号重新连接,服务器会向客户端发送 `FutureCursor` 错误。客户端需要决定在这些场景下采用什么策略。我们建议客户端将无序或重复的序列号视为错误,不处理消息,并断开连接。大多数客户端在没有人工操作干预的情况下不应重置序列状态,尽管这对某些不需要可靠传递流中每个事件的临时客户端来说可能是合理的行为。

## 使用和实现指南

当前的流传输主要是为服务器之间的数据同步而设计的。Web 应用程序也可以直接从最终用户浏览器连接,但请注意解码二进制帧和 DAG-CBOR 并非易事。

WebSocket 客户端库对 HTTP 重定向和 WebSocket 升级的组合支持并不一致。atproto 中并未特别要求或禁止此支持。

atproto 未指定支持的 WebSocket 标准版本。当前稳定的 WebSocket 标准是版本 13。实现应该做出合理的努力来支持现代版本,并保持一定程度的向后兼容性。

WebSocket 有独特的资源速率限制和拒绝服务问题。建议服务器和客户端都实施网络带宽限制和节流。服务器应调整并发连接限制和缓冲区大小以防止资源耗尽。

如果服务需要重置序列状态,建议选择一个比任何以前的序列号都高出很多的新初始序列号。例如,在持久存储丢失后,或在清除先前的流状态时。

引用特定主机上的流端点的 URL 通常应使用 `wss://` 作为 URI scheme(而不是 `https://`)。

## 安全和隐私考虑

如"连接"部分所述,在互联网上的流连接只应使用 `wss://`(SSL)。公共服务应拒绝非 SSL 连接。

大多数 HTTP XRPC 端点处理 JSON 形式的内容,而流端点直接处理 DAG-CBOR 对象作为不受信任的输入。必须采取预防措施防止恶意数据编码和数据结构操作。具体问题在[数据模型](/specs/data-model)和[仓库](/specs/repository)规范中讨论。

## 可能的未来变更

事件流是 AT Protocol 最新的组件之一,与其他组件相比,其细节更可能被迭代。

序列号方案可能会被调整以更好地支持分片流。其动机是通过在多个连接之间拆分来处理公共互联网上更高的数据吞吐量。

可能会指定其他传输(除了 WebSocket)和编码(除了 DAG-CBOR)。例如,文本 WebSocket 帧中的 JSON 负载在浏览器中更容易解码。

可能会采用额外的 WebSocket 功能:

- 传输压缩"扩展",如 `permessage-deflate`
- 子协议的定义
- 双向消息传递
- 1000 类响应代码

此规范中的模糊之处可能会得到解决,或保持开放。例如:

- HTTP 重定向
- CORS 和浏览器连接的其他问题
- 最大消息/帧大小

可能会支持类似于常规 HTTP XRPC 端点的认证方案。
