export const metadata = {
  title: '账户',
  description:
    '账户托管与生命周期',
}

# 账户托管

atproto 网络中的所有用户都有一个基于唯一且不可变 DID 的“身份”。活跃用户还会在个人数据服务器（PDS）上拥有一个“账户”。PDS 提供多种网络服务，包括仓库托管、授权与认证、以及 blob 存储。账户有生命周期（包括删除和下架）。身份可以在托管服务商之间迁移。下游服务，包括 relays 和 AppViews，可以重新分发账户内容。

每个重新分发内容的服务都必须独立决定要托管和分发哪些账户和内容。例如，他们可能专注于网络中的某一部分账户，定义自己的内容政策，或有地区法律义务。所有服务都应遵守某些协议级账户操作（如下所述），如临时账户停用。综合来看，每个网络服务对其分发公共数据的每个账户都有一个综合的“托管状态”。

本文档描述了网络中账户和身份可能具有的各种托管状态、状态变化时下游服务的预期行为，以及账户如何在托管服务商（PDS 实例）之间迁移。

## 托管状态

在任何网络服务上，已知账户在某一时刻要么是 `active`（活跃），要么不是（布尔标志）。如果账户不是活跃的，服务不应重新分发该账户的内容（仓库、单独记录、blobs 等）。如果账户未知（从未见过），状态可以是未定义的。

身份元数据（DID 文档和 handle 状态）以及账户托管状态本身，与托管内容是分离的，可以被重新分发。

鼓励网络服务实现 API 端点（如 `com.atproto.sync.getRepoStatus`），用于描述单个账户的当前托管状态。如果他们暴露事件流，也应在本地账户托管状态更新时为账户发出 `#account` 事件。

除了 `active` 布尔值外，账户还可能处于更具体的状态（所有这些都对应 `active=false`）：

- `deleted`：用户或主机已删除账户，内容应从网络中移除。通常为永久或长期，但可能被恢复（已删除账户可在同一或另一主机上重新激活）。
- `deactivated`：用户已临时暂停其整体账户。内容不应显示或重新分发，但不需要从基础设施中删除。通常为限时状态。也是账户迁移到另一个 PDS 实例后的初始状态。
- `takendown`：主机或服务已下架账户。通常为永久或长期，但可能被恢复。
- `suspended`：主机或服务已临时暂停账户。通常为限时状态。

未来会添加新的账户状态。为防止预期破坏，相关 API 端点（如 `com.atproto.sync.getRepoStatus` 和 `com.atproto.sync.subscribeRepos` 事件流上的 `#account` 事件）将 `active` 作为布尔标志分离，并用单独的 `status` 字符串明确非活跃账户。服务应使用 `active` 标志控制账户的整体可见性（可观察行为），`status` 字符串作为补充说明，可决定更具体的基础设施行为（如数据删除）。

停用和暂停状态被认为是临时的，尽管可能持续不定期。删除和下架被认为更为最终，但实际上也可以被恢复（且在实践中经常发生）。

下游服务可能会在下架后迅速删除内容（如同删除），或仅停止重新分发内容，等待后续处理。

身份也可能被 tombstoned（墓碑化），这通常被认为是永久且最终的，但在某些条件下也可被逆转。如果账户的身份为 `tombstoned`，账户托管状态应视为 `deleted`。

总结来说，当账户状态为非 `active` 时，主机不应重新分发的内容包括：

- 仓库导出（CAR 文件）
- 仓库记录
- 转换后的记录（“views”、embeds 等）
- blobs
- 转换后的 blobs（缩略图等）

### 托管状态传播

与 atproto 的其他方面不同，账户状态不是自认证的，也没有方法在任意方之间进行账户状态的认证转移或重新分发。

最常见的是，账户状态以“逐跳”方式传播，每个“下游”服务接受并采用其上游账户的托管状态。如果中间服务（如 relay）覆盖了上游的状态（例如基础设施账户下架），他们会向下游订阅者广播并传播该操作。

默认情况下，如果账户当前的活跃 PDS 不可用，账户状态应保持不变，至少在一段时间内如此。这保证了网络的弹性，并在基础设施临时故障期间保持账户在线。服务可以自行决定对于 PDS 长期离线的账户的策略。

一般预期是，下游服务不会将账户列为 `active`，如果其在上游服务为非活跃。然而，“上游”的概念是非正式的，服务在某些边缘情况可能需要自行定义策略。例如，AppView 可能从多个独立 relay 提供商获取数据，由于政策差异，他们对同一账户报告不同状态。如果 relay 与 PDS 之间的网络连接中断，他们也可能对同一账户报告不同状态。

如果对账户在网络中的总体状态有疑问，可以使用 `com.atproto.sync.getRepoStatus` 端点查询账户当前的活跃 PDS 主机。如果账户在那里不是 `active`，通常预期在其他地方也不是活跃的，尤其是在用户发起的操作（停用或删除）情况下。

### 内容删除

与整体账户状态不同，单个内容也可以被移除。当账户从其公共仓库中移除记录时，托管服务应移除对该内容的公共访问。

如果应用程序需要显式的“墓碑”（即内容曾经存在的标记），应在 Lexicon schema 中明确设计。若没有应用级显式墓碑，服务应不区分从未存在过的内容与已被完全删除的内容。注意，这与账户级别的删除不同，后者是被鼓励明确标记的。

## PDS 账户迁移

在高层次上，账户当前的 PDS 主机在账户的 DID 文档中指明。如果 DID 文档被更新指向新的 PDS 主机，且该主机上的账户状态为 `active`，并且有一个有效的仓库（具有有效签名和提交 `rev`），那么账户就已成功迁移。

在协议层面，这就是账户迁移的工作方式。在某些情况下，当之前的 PDS 实例不可用或账户状态为非活跃时，进入上述状态可能是唯一的账户恢复路径。

但在常见情况下，当当前 PDS 上有一个活跃账户时，可以实现更无缝的账户迁移流程。大致可分为以下几个高层步骤：

- 在新 PDS 上创建账户（可能初始为 `active=false`，如 `deactivated`）
- 将数据从旧 PDS 迁移到新 PDS
- 更新身份（DID 文档）指向新 PDS，并使用新的 atproto 签名密钥。对于 PLC DID，通常还涉及更新 PLC 轮换密钥。
- 在两个 PDS 实例上分别更新账户状态，使旧实例为非活跃，新实例为活跃
- 从新 PDS 发出 `#commit` 事件，由新的 atproto 签名密钥签名，且提交 `rev` 更高。

## 使用与实现指南

一种可能的账户迁移流程在[单独的指南](/guides/account-migration)中有详细描述。请注意，文中描述的具体机制并非协议正式部分，也不是迁移账户的唯一方式。

关于不同账户事件期间 firehose 事件顺序的具体指南，请参见[账户生命周期最佳实践指南](/guides/account-lifecycle)。

## 安全注意事项

账户托管状态未被认证，并且对每个网络服务都是独立的。当前活跃的 PDS 主机是查询整体账户状态的良好默认选择，尽管它可能不代表整个网络的共识（例如，中间服务下架），并且 PDS 主机在技术上有可能错误地报告账户激活状态。

处理账户状态变更可能会对下游服务造成资源压力。建议在账户（DID）级别和上游服务提供商（如 PDS）级别实施速率限制，以防止恶意行为者发起资源耗尽攻击。在这种情况下，将相关账户置为非活跃状态（如 `suspended`）可能是合适的，以防止账户“被锁定为开放状态”。

身份（DID 和 handle）的控制权在 atproto 权限模型中至关重要。当用户将身份管理委托给主机（如使用 `did:plc` 时），应特别谨慎选择和评估其 PDS 主机。

## 未来工作

账户在托管服务商之间迁移是 atproto 的核心设计目标之一，预计未来协议将支持更多账户迁移相关特性。

迁移流程本身也有望进一步改进和简化。
