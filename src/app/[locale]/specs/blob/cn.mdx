export const metadata = {
  title: 'Blobs',
  description:
    '被记录引用的媒体文件',
}

# Blobs

"Blobs" 是存储在账户仓库中的媒体文件。它们包括图片、视频和音频，也可以包含任何其他文件格式。Blobs 通过 `blob` lexicon 数据类型被单个记录引用，其中包含了 blob 的内容哈希值(CID)。

Blob 文件的上传和分发是与记录分开的。Blobs 由账户的 PDS 实例权威存储，但视图通常由与各个应用程序("AppViews")相关的 CDN 提供服务，以减少 PDS 的流量负载。CDN 可能会提供原始 blob 的转换版本(调整大小、转码等)。

虽然 blobs 在全局范围内都是通过内容寻址的(通过 CID)，但它们总是在单个账户(DID)的上下文中被引用和管理。

空 blob(零字节)通常是有效的，尽管个别 Lexicons/应用程序可能会禁止使用。

## Blob 元数据

目前，blobs 唯一"认可"的 CID 类型与仓库记录的类似，但使用 `raw` multicodec：

- CIDv1
- Multibase：DAG-CBOR 中的二进制序列化(或 JSON 映射中的 `base32`)
- Multicodec：`raw` (0x55)
- Multihash：`sha-256` 使用 256 位 (0x12)

base32 字符串编码的 blob CID 示例：`bafkreibjfgx2gprinfvicegelk5kosd6y2frmqpqzwqkg7usac74l3t2v4`

Blob 元数据还包括 blob 的大小(以字节为单位)和 MIME 类型。大小和 CID 是确定性的，必须有效且一致。MIME 类型则相对主观一些：同样的字节可能对多个 MIME 类型都是有效的。

## Blob 生命周期

在创建引用 blob 的记录之前，必须先将 blobs 上传到 PDS。注意，服务器在接收上传时并不知道预期的 Lexicon，因此在初始上传时只能应用通用的 blob 限制和约束，然后在创建记录时再执行 Lexicon 定义的限制。

客户端使用其 PDS 上的 `com.atproto.repo.uploadBlob` 端点，该端点将以 Lexicon blob 对象的形式返回经过验证的元数据。客户端"应该"在上传请求中设置 HTTP `Content-Type` 头和 `Content-Length` 头。上传也可能允许使用分块传输编码。服务器可能会嗅探 blob 的 mimetype 以验证所声明的 `Content-Type` 头，并在响应中返回修改后的 mimetype，或拒绝上传。参见下面的"安全注意事项"。如果实际的 blob 上传大小与 `Content-Length` 头不符，服务器应该拒绝上传。

上传成功后，blobs 被放置在临时存储中。在这种状态下，它们无法下载或分发。服务器应该在适当的时间跨度内"垃圾回收"(删除)未被引用的临时 blobs(参见下面的实现指南)。处于临时存储中的 blobs 不应包含在 `listBlobs` 输出中。

现在可以通过在记录中包含返回的 blob 元数据来引用上传的 blob。在处理记录创建时，服务器提取所有引用的 blobs 集合，并检查它们是否已被引用或在临时存储中。一旦记录创建成功，服务器就会使 blob 可公开访问。

同一个 blob 可以被同一仓库中的多个记录引用。重新上传已经存储和引用的 blob 不会对现有的 blobs 或记录产生任何变化。

当引用 blobs 的记录被删除时，服务器会检查同一仓库中是否有其他当前记录引用该 blob。如果没有，该 blob 会随记录一起删除。

当账户被删除时，所有托管的 blobs 都会在合理的时间范围内被删除。当账户被停用、下线或暂停时，blobs 不应公开访问。

服务器可以决定使单个 blobs 无法访问，这与任何账户下线或其他账户生命周期事件是分开的。

创建引用不存在 blob 的新记录时，应在创建(或更新)时被拒绝。但是，服务器可能会托管引用本地不可用 blobs 的仓库记录。例如，在批量仓库导入或账户迁移期间；数据丢失；或由于政策原因而删除/移除内容。

可以使用 `com.atproto.sync.getBlob` 端点从 PDS 获取原始 blobs。服务器应返回适当的 `Content-Type` 和 `Content-Length` HTTP 头。不建议也不需要直接从 PDS 向最终用户浏览器提供媒体服务，服务器不需要支持或促进这种用例。更多信息请参见下面的"安全注意事项"。

## 使用和实现指南

服务器可能有自己的通用 blob 限制和政策，这与任何 Lexicon 定义的约束是分开的。它们可能实现账户级别的数据存储配额、最大 blob 大小、内容政策等。这些限制中的任何一个都可能在初始上传时执行。服务器运营者应该意识到，限制和其他约束可能会影响现有和未来应用程序的功能。为了最大化互操作性，建议运营者优先考虑整体账户资源消耗的限制(例如，"总 blob 大小"配额，而不是"每个 blob"的大小限制)。

某些应用程序在 blob 上传和从记录引用之间可能有很长的延迟。为了最大化互操作性，建议服务器实现和运营者在"垃圾回收"前允许几个小时的宽限期，至少一小时是坚决的下限。

## 安全注意事项

从 web 服务器提供任意用户上传的文件会引发许多内容安全问题。例如，来自与其他网页相同"源"的脚本或 SVG 内容的跨站点脚本(XSS)。对 `getBlob` 端点启用内容安全策略(LINK: https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)实际上是强制性的。不支持直接从 blob 存储(`getBlob` 端点)动态地向浏览器和 web 应用程序提供资产。应用程序在向浏览器和 web 代理提供服务之前，必须通过独立的 CDN、代理或其他 web 服务代理 blobs、文件和资产，此类服务需要实施安全预防措施。

此端点的内容安全头示例如下：

